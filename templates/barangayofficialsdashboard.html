<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barangay Officials Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/barangayofficialsdashboard.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Header Navigation -->
    <header>
        <div class="container">
            <nav>
                <div class="logo">BCCMS</div>
                <ul class="menu">
                    <li><a href="#dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="#complaints"><i class="fas fa-exclamation-circle"></i> Complaints</a></li>
                    <li><a href="#messages"><i class="fas fa-envelope"></i> Messages</a></li>
                    <li><a href="#notifications"><i class="fas fa-bell"></i> Notifications</a></li>
                    <li><a href="#feedback"><i class="fas fa-comment-alt"></i> Feedback</a></li>
                    <li class="user-menu">
                        <a href="#profile"><i class="fas fa-user-circle"></i> Profile</a>
                        <div class="dropdown-content">
                            <a href="#profile"><i class="fas fa-user"></i> My Profile</a>
                            <a href="#settings"><i class="fas fa-cog"></i> Settings</a>
                            <a href="{{ url_for('auth.show_auth', form_type='login') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </li>
                </ul>
                <div class="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </div>
            </nav>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu">
        <a href="#dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        <a href="#complaints"><i class="fas fa-exclamation-circle"></i> Complaints</a>
        <a href="#messages"><i class="fas fa-envelope"></i> Messages</a>
        <a href="#notifications"><i class="fas fa-bell"></i> Notifications</a>
        <a href="#feedback"><i class="fas fa-comment-alt"></i> Feedback</a>
        <a href="#profile"><i class="fas fa-user"></i> Profile</a>
        <a href="#settings"><i class="fas fa-cog"></i> Settings</a>
        <a href="{{ url_for('auth.show_auth', form_type='login') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <!-- Main Content -->
    <main class="container">
        <!-- Dashboard Overview -->
        <section id="dashboard" class="dashboard">
            <h1><i class="fas fa-user-shield"></i> Barangay Officials Dashboard</h1>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Complaints</h3>
                    <p class="stat-number">142</p>
                    <p class="stat-change"><i class="fas fa-arrow-up"></i> 12% from last month</p>
                </div>
                <div class="stat-card">
                    <h3>Pending</h3>
                    <p class="stat-number">28</p>
                    <p class="stat-urgent"><i class="fas fa-exclamation-triangle"></i> 5 urgent</p>
                </div>
                <div class="stat-card">
                    <h3>Resolved</h3>
                    <p class="stat-number">89</p>
                    <p class="stat-change"><i class="fas fa-arrow-up"></i> 8% from last month</p>
                </div>
                <div class="stat-card">
                    <h3>Avg. Resolution Time</h3>
                    <p class="stat-number">3.2 days</p>
                    <p class="stat-change"><i class="fas fa-arrow-down"></i> 0.5 days from last month</p>
                </div>
            </div>

            <!-- Complaint Management -->
            <div class="complaint-management">
                <div class="sidebar">
                    <h3>Quick Actions</h3>
                    <ul>
                        <li><a href="#all-complaints"><i class="fas fa-list"></i> All Complaints <span class="badge">142</span></a></li>
                        <li><a href="#new-complaints"><i class="fas fa-plus-circle"></i> New Complaints <span class="badge">5</span></a></li>
                        <li><a href="#pending"><i class="fas fa-clock"></i> Pending Review <span class="badge">12</span></a></li>
                        <li><a href="#in-progress"><i class="fas fa-spinner"></i> In Progress <span class="badge">8</span></a></li>
                        <li><a href="#escalated"><i class="fas fa-exclamation-triangle"></i> Escalated <span class="badge">3</span></a></li>
                        <li><a href="#resolved"><i class="fas fa-check-circle"></i> Resolved <span class="badge">89</span></a></li>
                    </ul>
                </div>

                <div class="content-area">
                    <div class="section-header">
                        <h2><i class="fas fa-list"></i> Recent Complaints</h2>
                        <a href="#all-complaints" class="btn-link">View All</a>
                    </div>
                    
                    <table class="complaints-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Submitted</th>
                                <th>Resident</th>
                                <th>Status</th>
                                <th>Urgency</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>BCMS-2025-045</td>
                                <td>Noise</td>
                                <td>Today</td>
                                <td>Juan Dela Cruz</td>
                                <td><span class="status new">New</span></td>
                                <td><span class="urgency high">High</span></td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="#view" class="btn-action btn-view"><i class="fas fa-eye"></i></a>
                                        <a href="#update" class="btn-action btn-update"><i class="fas fa-edit"></i></a>
                                        <a href="#message" class="btn-action btn-message"><i class="fas fa-envelope"></i></a>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>BCMS-2025-044</td>
                                <td>Garbage</td>
                                <td>Yesterday</td>
                                <td>Maria Santos</td>
                                <td><span class="status pending">Pending</span></td>
                                <td><span class="urgency medium">Medium</span></td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="#view" class="btn-action btn-view"><i class="fas fa-eye"></i></a>
                                        <a href="#update" class="btn-action btn-update"><i class="fas fa-edit"></i></a>
                                        <a href="#message" class="btn-action btn-message"><i class="fas fa-envelope"></i></a>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>BCMS-2025-043</td>
                                <td>Road</td>
                                <td>2 days ago</td>
                                <td>Pedro Reyes</td>
                                <td><span class="status in-progress">In Progress</span></td>
                                <td><span class="urgency high">High</span></td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="#view" class="btn-action btn-view"><i class="fas fa-eye"></i></a>
                                        <a href="#update" class="btn-action btn-update"><i class="fas fa-edit"></i></a>
                                        <a href="#message" class="btn-action btn-message"><i class="fas fa-envelope"></i></a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Messages Section -->
        <section id="messages" class="messages-section">
            <div class="section-header">
                <h2><i class="fas fa-envelope"></i> Messages</h2>
                <span class="notification-count">3</span>
            </div>
            <div class="messages-list">
                <div class="message-card unread">
                    <div class="message-sender">
                        <div class="sender-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="sender-info">
                            <h3>Juan Dela Cruz</h3>
                            <p class="message-preview">Regarding my complaint about noise disturbance...</p>
                        </div>
                    </div>
                    <div class="message-meta">
                        <span class="message-time">2 hours ago</span>
                        <button class="btn-mark-read"><i class="far fa-check-circle"></i></button>
                    </div>
                </div>
                
                <div class="message-card">
                    <div class="message-sender">
                        <div class="sender-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="sender-info">
                            <h3>Maria Santos</h3>
                            <p class="message-preview">Thank you for resolving my garbage complaint...</p>
                        </div>
                    </div>
                    <div class="message-meta">
                        <span class="message-time">1 day ago</span>
                        <button class="btn-mark-read"><i class="far fa-check-circle"></i></button>
                    </div>
                </div>
                
                <div class="message-card">
                    <div class="message-sender">
                        <div class="sender-avatar">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="sender-info">
                            <h3>Homeowners Association</h3>
                            <p class="message-preview">Meeting reminder for tomorrow at 3pm...</p>
                        </div>
                    </div>
                    <div class="message-meta">
                        <span class="message-time">3 days ago</span>
                        <button class="btn-mark-read"><i class="far fa-check-circle"></i></button>
                    </div>
                </div>
            </div>
            <div class="section-footer">
                <a href="#all-messages" class="btn-secondary"><i class="fas fa-inbox"></i> View All Messages</a>
                <a href="#new-message" class="btn-primary"><i class="fas fa-paper-plane"></i> New Message</a>
            </div>
        </section>

        <!-- Notifications Section -->
        <section id="notifications" class="notifications-section">
            <div class="section-header">
                <h2><i class="fas fa-bell"></i> Notifications</h2>
                <span class="notification-count">5</span>
            </div>
            <div class="notifications-list">
                <div class="notification-card unread">
                    <div class="notification-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="notification-content">
                        <h3>New Complaint Submitted</h3>
                        <p>Juan Dela Cruz has submitted a new complaint about noise disturbance.</p>
                        <span class="notification-time">30 minutes ago</span>
                    </div>
                    <button class="btn-mark-read"><i class="far fa-check-circle"></i></button>
                </div>
                
                <div class="notification-card unread">
                    <div class="notification-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="notification-content">
                        <h3>Complaint Resolved</h3>
                        <p>Your assigned complaint BCMS-2025-044 has been resolved.</p>
                        <span class="notification-time">2 hours ago</span>
                    </div>
                    <button class="btn-mark-read"><i class="far fa-check-circle"></i></button>
                </div>
                
                <div class="notification-card">
                    <div class="notification-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="notification-content">
                        <h3>Upcoming Meeting</h3>
                        <p>Barangay council meeting scheduled for tomorrow at 10:00 AM.</p>
                        <span class="notification-time">1 day ago</span>
                    </div>
                    <button class="btn-mark-read"><i class="far fa-check-circle"></i></button>
                </div>
            </div>
            <div class="section-footer">
                <a href="#all-notifications" class="btn-secondary"><i class="fas fa-list"></i> View All Notifications</a>
            </div>
        </section>

        <!-- Feedback Section -->
        <section id="feedback" class="feedback-section">
            <div class="section-header">
                <h2><i class="fas fa-comment-alt"></i> Resident Feedback</h2>
                <div class="feedback-filter">
                    <select id="feedback-filter">
                        <option value="all">All Feedback</option>
                        <option value="positive">Positive</option>
                        <option value="neutral">Neutral</option>
                        <option value="negative">Negative</option>
                        <option value="recent">Most Recent</option>
                    </select>
                </div>
            </div>
            
            <div class="feedback-list">
                <div class="feedback-card positive">
                    <div class="feedback-header">
                        <div class="resident-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="resident-info">
                            <h3>Maria Santos</h3>
                            <div class="rating-stars">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                            </div>
                        </div>
                        <span class="feedback-date">Today</span>
                    </div>
                    <div class="feedback-content">
                        <p>Thank you for resolving my garbage collection issue so quickly! The barangay staff were very professional and helpful throughout the process.</p>
                    </div>
                    <div class="feedback-meta">
                        <span class="complaint-reference">BCMS-2025-044</span>
                        <button class="btn-reply"><i class="fas fa-reply"></i> Reply</button>
                    </div>
                </div>
                
                <div class="feedback-card neutral">
                    <div class="feedback-header">
                        <div class="resident-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="resident-info">
                            <h3>Pedro Reyes</h3>
                            <div class="rating-stars">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="far fa-star"></i>
                            </div>
                        </div>
                        <span class="feedback-date">2 days ago</span>
                    </div>
                    <div class="feedback-content">
                        <p>The road repair was completed, but it took longer than expected. Communication could be improved about expected completion times.</p>
                    </div>
                    <div class="feedback-meta">
                        <span class="complaint-reference">BCMS-2025-043</span>
                        <button class="btn-reply"><i class="fas fa-reply"></i> Reply</button>
                    </div>
                </div>
                
                <div class="feedback-card negative">
                    <div class="feedback-header">
                        <div class="resident-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="resident-info">
                            <h3>Juan Dela Cruz</h3>
                            <div class="rating-stars">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="far fa-star"></i>
                                <i class="far fa-star"></i>
                                <i class="far fa-star"></i>
                            </div>
                        </div>
                        <span class="feedback-date">1 week ago</span>
                    </div>
                    <div class="feedback-content">
                        <p>My noise complaint was not handled well. The issue persists and I didn't receive updates on the status. Very disappointed with the service.</p>
                    </div>
                    <div class="feedback-meta">
                        <span class="complaint-reference">BCMS-2025-042</span>
                        <button class="btn-reply"><i class="fas fa-reply"></i> Reply</button>
                    </div>
                </div>
            </div>
            
            <div class="section-footer">
                <a href="#all-feedback" class="btn-secondary"><i class="fas fa-list"></i> View All Feedback</a>
                <a href="#feedback-report" class="btn-primary"><i class="fas fa-chart-bar"></i> Generate Feedback Report</a>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container footer-content">
            <div class="footer-section" style="text-align: center;">
                <h3>Barangay Officials</h3>
                <p><i>"Serving the community with integrity and dedication"</i></p>
                <p><i class="fas fa-clock"></i> Office Hours: Mon-Fri, 8:00 AM - 5:00 PM</p>
                <p><i class="fas fa-phone"></i> (02) 123-4567</p>
                <p><i class="fas fa-envelope"></i> officials@bccms.com</p>
            </div>
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="#dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="#complaints"><i class="fas fa-exclamation-circle"></i> Complaints</a></li>
                    <li><a href="#messages"><i class="fas fa-envelope"></i> Messages</a></li>
                    <li><a href="#notifications"><i class="fas fa-bell"></i> Notifications</a></li>
                    <li><a href="#feedback"><i class="fas fa-comment-alt"></i> Feedback</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>About BCCMS</h3>
                <p>Barangay Complaint and Communication Management System for efficient community service.</p>
                <div class="social-links">
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 Barangay Complaint Management System | Official Dashboard</p>
        </div>
    </footer>

    <!-- Status Update Modal -->
    <div id="status-update-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2><i class="fas fa-edit"></i> Update Complaint Status</h2>
            <form id="status-update-form">
                <input type="hidden" id="complaint-id" name="complaint_id">
                <div class="form-group">
                    <label for="status">Status:</label>
                    <select id="status" name="status" required>
                        <option value="">Select Status</option>
                        <option value="Pending Review">Pending Review</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Escalated">Escalated</option>
                        <option value="Resolved">Resolved</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="status-notes">Notes:</label>
                    <textarea id="status-notes" name="notes" rows="4" placeholder="Enter details about this status update..."></textarea>
                </div>
                <div class="form-group">
                    <label for="notify-resident">
                        <input type="checkbox" id="notify-resident" name="notify_resident" checked>
                        Notify resident about this update
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary cancel-btn">Cancel</button>
                    <button type="submit" class="btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Mobile menu toggle
    const mobileMenuToggle = document.querySelector(".mobile-menu-toggle");
    const mobileMenu = document.querySelector(".mobile-menu");
    
    if (mobileMenuToggle && mobileMenu) {
        mobileMenuToggle.addEventListener("click", () => {
            mobileMenu.style.display = mobileMenu.style.display === "block" ? "none" : "block";
        });
    }
    
    // Mark as read buttons
    const markReadButtons = document.querySelectorAll(".btn-mark-read");
    markReadButtons.forEach(btn => {
        btn.addEventListener("click", function() {
            const card = this.closest(".message-card, .notification-card");
            if (card) {
                card.classList.remove("unread");
                updateNotificationCounts();
            }
        });
    });
    
    // Update notification counts
    function updateNotificationCounts() {
        const unreadMessages = document.querySelectorAll(".message-card.unread").length;
        const unreadNotifications = document.querySelectorAll(".notification-card.unread").length;
        
        document.querySelectorAll(".notification-count").forEach(el => {
            if (el.closest("#messages")) {
                el.textContent = unreadMessages;
            } else if (el.closest("#notifications")) {
                el.textContent = unreadNotifications;
            }
        });
    }
    
    // Initialize counts on page load
    updateNotificationCounts();
    
    // Modal control
    const statusUpdateModal = document.getElementById("status-update-modal");
    const messageModal = document.getElementById("message-modal");
    const notificationSettingsModal = document.getElementById("notification-settings-modal");
    const feedbackReplyModal = document.getElementById("feedback-reply-modal");
    const openMessageButtons = document.querySelectorAll('a[href="#new-message"], .btn-reply');
    const openNotificationSettingsButton = document.querySelector('a[href="#notification-settings"]');
    const closeButtons = document.querySelectorAll(".close-btn");
    const cancelButtons = document.querySelectorAll(".cancel-btn");
    
    // Add logout functionality
    const logoutLinks = document.querySelectorAll('a[href*="login"]');
    logoutLinks.forEach(link => {
        link.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await fetch('/auth/logout');
                window.location.href = '/auth/login';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/auth/login';
            }
        });
    });
    
    function openModal(modal) {
        if (modal) {
            modal.style.display = "block";
            document.body.style.overflow = "hidden";
        }
    }
    
    function closeModal(modal) {
        if (modal) {
            modal.style.display = "none";
            document.body.style.overflow = "auto";
        }
    }
    
    // Open message modal
    if (openMessageButtons) {
        openMessageButtons.forEach(btn => {
            btn.addEventListener("click", (e) => {
                e.preventDefault();
                openModal(messageModal);
            });
        });
    }
    
    // Open notification settings modal
    if (openNotificationSettingsButton) {
        openNotificationSettingsButton.addEventListener("click", (e) => {
            e.preventDefault();
            openModal(notificationSettingsModal);
        });
    }
    
    // Open feedback reply modal
    if (document.querySelectorAll('.btn-reply')) {
        document.querySelectorAll('.btn-reply').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                openModal(feedbackReplyModal);
            });
        });
    }
    
    // Close buttons for modals
    if (closeButtons) {
        closeButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const modal = btn.closest(".modal");
                closeModal(modal);
            });
        });
    }
    
    // Cancel buttons for modals
    if (cancelButtons) {
        cancelButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const modal = btn.closest(".modal");
                closeModal(modal);
            });
        });
    }
    
    // Close modal when clicking outside
    window.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal")) {
            closeModal(e.target);
        }
    });
    
    // Status Update Form Submission
    const statusUpdateForm = document.getElementById("status-update-form");
    if (statusUpdateForm) {
        statusUpdateForm.addEventListener("submit", function(e) {
            e.preventDefault();
            
            const complaintId = document.getElementById("complaint-id").value;
            const status = document.getElementById("status").value;
            const notes = document.getElementById("status-notes").value;
            const notifyResident = document.getElementById("notify-resident").checked;
            
            // Call the function with the correct parameters
            updateComplaintStatus(complaintId, status, notes, notifyResident);
            
            // Close the modal
            const modal = document.getElementById("status-update-modal");
            closeModal(modal);
        });
    }
    
    // Other Form submissions
    const messageForm = document.getElementById("message-form");
    if (messageForm) {
        messageForm.addEventListener("submit", async function(e) {
            e.preventDefault();
            // Here you would send the message data to the server
            alert("Message sent successfully!");
            closeModal(messageModal);
        });
    }
    
    const notificationSettingsForm = document.getElementById("notification-settings-form");
    if (notificationSettingsForm) {
        notificationSettingsForm.addEventListener("submit", function(e) {
            e.preventDefault();
            // Here you would save the notification settings
            alert("Notification settings saved!");
            closeModal(notificationSettingsModal);
        });
    }
    
    const feedbackReplyForm = document.getElementById("feedback-reply-form");
    if (feedbackReplyForm) {
        feedbackReplyForm.addEventListener("submit", function(e) {
            e.preventDefault();
            // Here you would send the feedback response
            alert("Response sent successfully!");
            closeModal(feedbackReplyModal);
        });
    }
    
    // Initialize real-time updates
    initializeRealTimeUpdates();
    
    // Initialize event source for real-time updates if it exists
    try {
        const eventSource = new EventSource('/complaint/stream');
        
        // Handle incoming complaint updates
        eventSource.onmessage = function(event) {
            const complaints = JSON.parse(event.data);
            updateDashboard(complaints);
        };
        
        // Initialize the dashboard
        loadStats();
        loadComplaints('all');
        
        // Set up event listeners for complaint filters
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) {
            sidebar.addEventListener('click', function(e) {
                e.preventDefault();
                const link = e.target.closest('a[href^="#"]');
                if (!link) return;
                
                const href = link.getAttribute('href');
                let status = 'all';
                
                // Set the active class on the clicked link and remove from others
                sidebar.querySelectorAll('a').forEach(a => a.classList.remove('active'));
                link.classList.add('active');
                
                // Determine which complaints to load based on the href
                switch(href) {
                    case '#all-complaints':
                        status = 'all';
                        break;
                    case '#new-complaints':
                        status = 'New';
                        break;
                    case '#pending':
                        status = 'Pending Review';
                        break;
                    case '#in-progress':
                        status = 'In Progress';
                        break;
                    case '#escalated':
                        loadEscalatedComplaints();
                        return; // Return early as we're calling a specialized function
                    case '#resolved':
                        status = 'Resolved';
                        break;
                    default:
                        status = 'all';
                        break;
                }
                
                loadComplaints(status);
            });
        }
        
        // Handle action buttons in the complaints table
        const complaintsTable = document.querySelector('.complaints-table');
        if (complaintsTable) {
            complaintsTable.addEventListener('click', function(e) {
                e.preventDefault();
                const target = e.target.closest('.btn-action');
                if (!target) return;
                
                const row = target.closest('tr');
                const complaintId = row.getAttribute('data-complaint-id') || row.cells[0].textContent;
                const residentEmail = row.getAttribute('data-resident-email') || '';
                
                // View complaint details
                if (target.classList.contains('btn-view')) {
                    viewComplaintDetails(complaintId);
                }
                
                // Assign complaint
                if (target.classList.contains('btn-assign')) {
                    showAssignModal(complaintId);
                }
                
                // Message resident
                if (target.classList.contains('btn-message')) {
                    showMessageModal(complaintId, residentEmail);
                }
                
                // Update status
                if (target.classList.contains('btn-update')) {
                    showStatusUpdateModal(complaintId);
                }
                
                // Escalate complaint
                if (target.classList.contains('btn-escalate')) {
                    showEscalateModal(complaintId);
                }
                
                // Resolve escalated complaint
                if (target.classList.contains('btn-resolve-escalated')) {
                    resolveEscalatedComplaint(complaintId);
                }
            });
        }
    } catch (error) {
        console.error("Error initializing event source:", error);
    }
});

// Define utility functions outside the DOM ready handler
function initializeRealTimeUpdates() {
    // This would connect to a WebSocket or use polling in a real application
    // For now, we'll just refresh the data periodically
    setInterval(() => {
        if (typeof updateNotificationCounts === 'function') {
            updateNotificationCounts();
        }
    }, 300000); // Refresh every 5 minutes
    
    // Also refresh when the window gains focus
    window.addEventListener('focus', () => {
        if (typeof updateNotificationCounts === 'function') {
            updateNotificationCounts();
        }
    });
}

// Initialize the application
function initializeApp() {
    // Check authentication status
    fetch('/auth/status', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
            return;
        }
        return response.json();
    })
    .then(data => {
        if (data && !data.authenticated) {
            window.location.href = '/auth/login';
        } else {
            // User is authenticated, continue with initialization
            initializeRealTimeUpdates();
            
            // Update user profile information
            if (data && data.user) {
                updateUserProfile(data.user);
            }
        }
    })
    .catch(error => {
        console.error('Authentication check failed:', error);
    });
}

// Update user profile information in the UI
function updateUserProfile(user) {
    const profileLinks = document.querySelectorAll('a[href="#profile"]');
    profileLinks.forEach(link => {
        if (link.querySelector('i.fa-user-circle')) {
            link.innerHTML = `<i class="fas fa-user-circle"></i> ${user.name || 'Profile'}`;
        }
    });
    
    // Update any other user-specific UI elements
}

// Load dashboard statistics and update badge counts
function loadStats() {
    fetch('/officials/stats')
        .then(response => response.json())
        .then(data => {
            const statCards = document.querySelectorAll('.stat-card');
            if (statCards.length >= 4) {
                document.querySelector('.stat-card:nth-child(1) .stat-number').textContent = data.total;
                document.querySelector('.stat-card:nth-child(2) .stat-number').textContent = data.pending + data.new;
                document.querySelector('.stat-card:nth-child(2) .stat-urgent').innerHTML = 
                    `<i class="fas fa-exclamation-triangle"></i> ${data.urgent_pending} urgent`;
                document.querySelector('.stat-card:nth-child(3) .stat-number').textContent = data.resolved;
                document.querySelector('.stat-card:nth-child(4) .stat-number').textContent = 
                    `${data.avg_resolution_time} days`;
            }
                
            // Update sidebar badges - fixed to ensure all badges get updated
            updateBadgeCount('a[href="#all-complaints"] .badge', data.total);
            updateBadgeCount('a[href="#new-complaints"] .badge', data.new);
            updateBadgeCount('a[href="#pending"] .badge', data.pending);
            updateBadgeCount('a[href="#in-progress"] .badge', data.in_progress);
            updateBadgeCount('a[href="#escalated"] .badge', data.escalated || 0);
            updateBadgeCount('a[href="#resolved"] .badge', data.resolved);
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
}

// Helper function to update badge counts
function updateBadgeCount(selector, count) {
    const badge = document.querySelector(selector);
    if (badge) {
        badge.textContent = count;
        // Add visual feedback for badge count changes
        badge.style.transition = 'background-color 0.3s ease';
        badge.style.backgroundColor = '#ff5722';
        setTimeout(() => {
            badge.style.backgroundColor = '';
        }, 1000);
    }
}

// Load complaints by status
function loadComplaints(status) {
    // Store the current status view in session storage
    sessionStorage.setItem('currentComplaintView', status);
    
    fetch(`/officials/complaints/${status.toLowerCase().replace(' ', '-')}`)
        .then(response => response.json())
        .then(complaints => {
            const tableBody = document.querySelector('.complaints-table tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = ''; // Clear current entries
            
            if (complaints.length === 0) {
                // Display a message when no complaints match the filter
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="7" class="empty-state">
                        <div class="empty-message">
                            <i class="fas fa-inbox"></i>
                            <p>No ${status === 'all' ? '' : status} complaints found</p>
                        </div>
                    </td>
                `;
                tableBody.appendChild(emptyRow);
            } else {
                complaints.forEach(complaint => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-complaint-id', complaint.id);
                    row.setAttribute('data-resident-email', complaint.user_email);
                    row.setAttribute('data-status', complaint.status);
                    
                    // Format date for display
                    const submittedDate = new Date(complaint.submitted_date);
                    const now = new Date();
                    const diffTime = Math.abs(now - submittedDate);
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    
                    let dateDisplay;
                    if (diffDays === 0) {
                        dateDisplay = 'Today';
                    } else if (diffDays === 1) {
                        dateDisplay = 'Yesterday';
                    } else {
                        dateDisplay = `${diffDays} days ago`;
                    }
                    
                    // Create action buttons based on status
                    let actionButtons = `
                        <a href="#view" class="btn-action btn-view"><i class="fas fa-eye"></i></a>
                    `;
                    
                    // Always include the update button regardless of status
                    actionButtons += `<a href="#update" class="btn-action btn-update"><i class="fas fa-edit"></i></a>`;
                    
                    if (complaint.status === 'New') {
                        actionButtons += `
                            <a href="#message" class="btn-action btn-message"><i class="fas fa-envelope"></i></a>
                        `;
                    } else if (complaint.status === 'Pending Review' || complaint.status === 'In Progress') {
                        actionButtons += `
                            <a href="#message" class="btn-action btn-message"><i class="fas fa-envelope"></i></a>
                        `;
                        
                        if (!complaint.escalated) {
                            actionButtons += `
                                <a href="#escalate" class="btn-action btn-escalate"><i class="fas fa-level-up-alt"></i></a>
                            `;
                        }
                    } else if (complaint.status === 'Escalated') {
                        actionButtons += `
                            <a href="#message" class="btn-action btn-message"><i class="fas fa-envelope"></i></a>
                        `;
                    } else if (complaint.status === 'Resolved') {
                        actionButtons += `
                            <a href="#message" class="btn-action btn-message"><i class="fas fa-envelope"></i></a>
                        `;
                    }
                    
                    row.innerHTML = `
                        <td>${complaint.id}</td>
                        <td>${complaint.category}</td>
                        <td>${dateDisplay}</td>
                        <td>${complaint.user_name || 'Resident'}</td>
                        <td><span class="status ${complaint.status.toLowerCase().replace(' ', '-')}">${complaint.status}</span></td>
                        <td><span class="urgency ${complaint.urgency.toLowerCase()}">${complaint.urgency}</span></td>
                        <td>
                            <div class="action-buttons">
                                ${actionButtons}
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }
            
            // Update heading to reflect the status
            const sectionHeader = document.querySelector('.content-area .section-header h2');
            if (sectionHeader) {
                const statusText = status === 'all' ? 'All' : status;
                sectionHeader.innerHTML = `<i class="fas fa-list"></i> ${statusText} Complaints`;
            }
            
            // Highlight the active filter in sidebar
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.querySelectorAll('a').forEach(a => {
                    a.classList.remove('active');
                    let href = a.getAttribute('href');
                    if ((status === 'all' && href === '#all-complaints') ||
                        (status === 'New' && href === '#new-complaints') ||
                        (status === 'Pending Review' && href === '#pending') ||
                        (status === 'In Progress' && href === '#in-progress') ||
                        (status === 'Resolved' && href === '#resolved')) {
                        a.classList.add('active');
                    }
                });
            }
        })
        .catch(error => {
            console.error(`Error loading ${status} complaints:`, error);
        });
}

// Load only escalated complaints
function loadEscalatedComplaints() {
    // Store the current status view
    sessionStorage.setItem('currentComplaintView', 'Escalated');
    
    fetch('/officials/complaints/escalated')
        .then(response => response.json())
        .then(complaints => {
            const tableBody = document.querySelector('.complaints-table tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = ''; // Clear current entries
            
            if (complaints.length === 0) {
                // Display a message when no escalated complaints found
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="7" class="empty-state">
                        <div class="empty-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>No escalated complaints found</p>
                        </div>
                    </td>
                `;
                tableBody.appendChild(emptyRow);
            } else {
                complaints.forEach(complaint => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-complaint-id', complaint.id);
                    row.setAttribute('data-resident-email', complaint.user_email);
                    row.setAttribute('data-status', 'Escalated');
                    
                    // Format date for display
                    const submittedDate = new Date(complaint.submitted_date);
                    const now = new Date();
                    const diffTime = Math.abs(now - submittedDate);
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    
                    let dateDisplay;
                    if (diffDays === 0) {
                        dateDisplay = 'Today';
                    } else if (diffDays === 1) {
                        dateDisplay = 'Yesterday';
                    } else {
                        dateDisplay = `${diffDays} days ago`;
                    }
                    
                    // Ensure message and update buttons remain for escalated complaints
                    row.innerHTML = `
                        <td>${complaint.id}</td>
                        <td>${complaint.category}</td>
                        <td>${dateDisplay}</td>
                        <td>${complaint.user_name || 'Resident'}</td>
                        <td><span class="status escalated">Escalated</span></td>
                        <td><span class="urgency ${complaint.urgency.toLowerCase()}">${complaint.urgency}</span></td>
                        <td>
                            <div class="action-buttons">
                                <a href="#view" class="btn-action btn-view"><i class="fas fa-eye"></i></a>
                                <a href="#update" class="btn-action btn-update"><i class="fas fa-edit"></i></a>
                                <a href="#message" class="btn-action btn-message"><i class="fas fa-envelope"></i></a>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }
            
            // Update heading
            const sectionHeader = document.querySelector('.content-area .section-header h2');
            if (sectionHeader) {
                sectionHeader.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Escalated Complaints`;
            }
            
            // Highlight the active filter in sidebar
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.querySelectorAll('a').forEach(a => {
                    a.classList.remove('active');
                    if (a.getAttribute('href') === '#escalated') {
                        a.classList.add('active');
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error loading escalated complaints:', error);
        });
}

// View complaint details
function viewComplaintDetails(complaintId) {
    // In a real application, you would fetch the complaint details from the server
    // and display them in a modal or new page
    alert(`View details for complaint: ${complaintId}`);
}

// Show modal to assign complaint to an official
function showAssignModal(complaintId) {
    // In a real application, you would populate a modal with officials to assign to
    alert(`Assign complaint: ${complaintId}`);
}

// Show modal to message a resident
function showMessageModal(complaintId, residentEmail) {
    // In a real application, you would populate a modal with message form
    alert(`Message resident regarding complaint: ${complaintId}`);
}

// Show modal to update complaint status
function showStatusUpdateModal(complaintId) {
    const modal = document.getElementById("status-update-modal");
    if (!modal) return;
    
    // Set complaint ID in hidden field
    const complaintIdField = document.getElementById("complaint-id");
    if (complaintIdField) {
        complaintIdField.value = complaintId;
    }
    
    // Reset form fields
    const statusSelect = document.getElementById("status");
    const statusNotes = document.getElementById("status-notes");
    
    if (statusSelect) statusSelect.selectedIndex = 0;
    if (statusNotes) statusNotes.value = '';
    
    // Show the modal
    modal.style.display = "block";
    document.body.style.overflow = "hidden";
}

// Show modal to escalate a complaint
function showEscalateModal(complaintId) {
    // In a real application, you would show an escalation form
    if (confirm(`Are you sure you want to escalate complaint ${complaintId}?`)) {
        updateComplaintStatus(complaintId, 'Escalated', 'Escalated to higher authorities', true);
    }
}

// Resolve an escalated complaint
function resolveEscalatedComplaint(complaintId) {
    if (confirm(`Are you sure you want to resolve escalated complaint ${complaintId}?`)) {
        updateComplaintStatus(complaintId, 'Resolved', 'Resolved from escalation', true);
    }
}

// Update complaint status in UI and (in a real app) on the server
function updateComplaintStatus(complaintId, newStatus, notes, notifyResident) {
    // In a real application, you would send this to the server
    console.log(`Updating complaint ${complaintId} to ${newStatus}`);
    console.log(`Notes: ${notes}`);
    console.log(`Notify resident: ${notifyResident}`);
    
    // Mock API call
    fetch('/officials/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            complaint_id: complaintId,
            status: newStatus,
            action_note: notes,
            notify_resident: notifyResident
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to update status');
        return response.json();
    })
    .then(data => {
        // Success! Update the UI
        const row = document.querySelector(`tr[data-complaint-id="${complaintId}"]`);
        
        if (row) {
            // Get the current view from session storage
            const currentView = sessionStorage.getItem('currentComplaintView') || 'all';
            
            // If we're not viewing "All Complaints" and the status has changed to something 
            // that doesn't match the current filter, we need to remove the row
            if (currentView !== 'all' && currentView !== newStatus) {
                // Remove the row with animation
                row.style.transition = "opacity 0.5s";
                row.style.opacity = "0";
                setTimeout(() => {
                    row.remove();
                    
                    // Check if there are no complaints left and show empty state if needed
                    const tableBody = document.querySelector('.complaints-table tbody');
                    if (tableBody && tableBody.querySelectorAll('tr:not(.empty-state)').length === 0) {
                        const emptyRow = document.createElement('tr');
                        emptyRow.className = 'empty-state';
                        emptyRow.innerHTML = `
                            <td colspan="7">
                                <div class="empty-message">
                                    <i class="fas fa-inbox"></i>
                                    <p>No ${currentView === 'all' ? '' : currentView} complaints found</p>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(emptyRow);
                    }
                }, 500);
            } else {
                // Update status cell
                const statusCell = row.querySelector('td:nth-child(5)');
                if (statusCell) {
                    statusCell.innerHTML = `<span class="status ${newStatus.toLowerCase().replace(' ', '-')}">${newStatus}</span>`;
                }
                
                // Update data-status attribute
                row.setAttribute('data-status', newStatus);
                
                // Update action buttons - always include update button
                const actionsCell = row.querySelector('td:last-child');
                if (actionsCell) {
                    let actionButtons = `
                        <a href="#view" class="btn-action btn-view"><i class="fas fa-eye"></i></a>
                        <a href="#update" class="btn-action btn-update"><i class="fas fa-edit"></i></a>
                    `;
                    
                    if (newStatus === 'New') {
                        actionButtons += `
                            <a href="#message" class="btn-action btn-message"><i class="fas fa-envelope"></i></a>
                        `;
                    } else if (newStatus === 'Pending Review' || newStatus === 'In Progress') {
                        actionButtons += `
                            <a href="#message" class="btn-action btn-message"><i class="fas fa-envelope"></i></a>
                        `;
                        
                        if (newStatus !== 'Escalated') {
                            actionButtons += `
                                <a href="#escalate" class="btn-action btn-escalate"><i class="fas fa-level-up-alt"></i></a>
                            `;
                        }
                    } else if (newStatus === 'Escalated') {
                        actionButtons += `
                            <a href="#message" class="btn-action btn-message"><i class="fas fa-envelope"></i></a>
                        `;
                    } else if (newStatus === 'Resolved') {
                        actionButtons += `
                            <a href="#message" class="btn-action btn-message"><i class="fas fa-envelope"></i></a>
                        `;
                    }
                    
                    actionsCell.innerHTML = `<div class="action-buttons">${actionButtons}</div>`;
                }
            }
        }
        
        // Add notification
        const notification = document.createElement('div');
        notification.className = 'notification-toast success';
        notification.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <span>Complaint ${complaintId} status updated to ${newStatus}</span>
            <button class="close-toast">&times;</button>
        `;
        document.body.appendChild(notification);
        
        // Remove notification after 3 seconds
        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => notification.remove(), 500);
        }, 3000);
        
        // Refresh stats and badge counts
        loadStats();
    })
    .catch(error => {
        console.error('Error updating complaint status:', error);
        
        // Show error notification
        const notification = document.createElement('div');
        notification.className = 'notification-toast error';
        notification.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <span>Failed to update complaint status: ${error.message}</span>
            <button class="close-toast">&times;</button>
        `;
        document.body.appendChild(notification);
        
        // Remove notification after 3 seconds
        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    });
}

// Update dashboard with real-time data
function updateDashboard(complaints) {
    // Refresh stats
    loadStats();
    
    // Get current active view
    const sectionHeader = document.querySelector('.content-area .section-header h2');
    if (sectionHeader) {
        const headerText = sectionHeader.textContent;
        if (headerText.includes('All')) {
            loadComplaints('all');
        } else if (headerText.includes('New')) {
            loadComplaints('New');
        } else if (headerText.includes('Pending')) {
            loadComplaints('Pending Review');
        } else if (headerText.includes('In Progress')) {
            loadComplaints('In Progress');
        } else if (headerText.includes('Escalated')) {
            loadEscalatedComplaints();
        } else if (headerText.includes('Resolved')) {
            loadComplaints('Resolved');
        } else {
            loadComplaints('all');
        }
    } else {
        loadComplaints('all');
    }
}

// Add CSS selector polyfill for older browsers
if (!Element.prototype.matches) {
    Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector;
}

if (!Element.prototype.closest) {
    Element.prototype.closest = function(s) {
        var el = this;
        do {
            if (el.matches(s)) return el;
            el = el.parentElement || el.parentNode;
        } while (el !== null && el.nodeType === 1);
        return null;
    };
}

// Close toast notifications when clicking the close button
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('close-toast')) {
        const toast = e.target.closest('.notification-toast');
        if (toast) {
            toast.classList.add('fade-out');
            setTimeout(() => toast.remove(), 500);
        }
    }
});

// Start the application
document.addEventListener("DOMContentLoaded", function() {
    initializeApp();
});
</script>
</body>
</html>